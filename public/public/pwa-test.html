<!DOCTYPE html>
<html>
<head>
    <title>PWA Installation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #0e1117;
            color: #fafafa;
            max-width: 800px;
            margin: 0 auto;
        }
        .check {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .pass { background: #10b981; color: white; }
        .fail { background: #ef4444; color: white; }
        .info { background: #3b82f6; color: white; }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #059669; }
        .icon-preview {
            display: inline-block;
            margin: 10px;
            text-align: center;
        }
        .icon-preview img {
            border: 2px solid #4b5563;
            border-radius: 8px;
            display: block;
            margin: 5px auto;
        }
    </style>
</head>
<body>
    <h1>üèâ PWA Installation Test</h1>
    <p>This page helps verify your PWA setup is correct.</p>
    
    <div id="results"></div>
    
    <h2>Icon Previews</h2>
    <div class="icon-preview">
        <strong>192x192</strong>
        <img src="/icon-192.png" alt="192 icon" onerror="this.style.border='3px solid red'">
    </div>
    <div class="icon-preview">
        <strong>512x512</strong>
        <img src="/icon-512.png" alt="512 icon" onerror="this.style.border='3px solid red'">
    </div>
    
    <h2>Manual Install</h2>
    <button id="installBtn" style="display:none;">Install App</button>
    <p id="installStatus"></p>
    
    <script>
        const results = document.getElementById('results');
        const checks = [];
        
        // Check 1: HTTPS
        const isHTTPS = location.protocol === 'https:';
        checks.push({
            name: 'HTTPS',
            pass: isHTTPS,
            message: isHTTPS ? 'Site is served over HTTPS ‚úì' : 'Site must be served over HTTPS'
        });
        
        // Check 2: Manifest
        fetch('/manifest.json')
            .then(r => r.json())
            .then(manifest => {
                checks.push({
                    name: 'Manifest',
                    pass: true,
                    message: 'Manifest.json is accessible ‚úì'
                });
                
                // Check icons in manifest
                if (manifest.icons && manifest.icons.length >= 2) {
                    checks.push({
                        name: 'Manifest Icons',
                        pass: true,
                        message: `Found ${manifest.icons.length} icons in manifest ‚úì`
                    });
                } else {
                    checks.push({
                        name: 'Manifest Icons',
                        pass: false,
                        message: 'Manifest must have at least 2 icons'
                    });
                }
                
                displayResults();
            })
            .catch(() => {
                checks.push({
                    name: 'Manifest',
                    pass: false,
                    message: 'Cannot load manifest.json'
                });
                displayResults();
            });
        
        // Check 3: Service Worker
        if ('serviceWorker' in navigator) {
            // First check if already registered
            navigator.serviceWorker.getRegistration()
                .then(reg => {
                    if (reg) {
                        checks.push({
                            name: 'Service Worker',
                            pass: true,
                            message: 'Service Worker is registered ‚úì'
                        });
                        displayResults();
                    } else {
                        // Try to register it
                        navigator.serviceWorker.register('/service-worker.js', { scope: '/' })
                            .then(registration => {
                                checks.push({
                                    name: 'Service Worker',
                                    pass: true,
                                    message: 'Service Worker registered successfully ‚úì'
                                });
                                displayResults();
                            })
                            .catch(error => {
                                // Check if service worker file is accessible
                                fetch('/service-worker.js')
                                    .then(r => {
                                        if (r.ok) {
                                            checks.push({
                                                name: 'Service Worker',
                                                pass: false,
                                                message: `Registration failed: ${error.message}. File is accessible but registration error occurred.`
                                            });
                                        } else {
                                            checks.push({
                                                name: 'Service Worker',
                                                pass: false,
                                                message: `Service Worker file not accessible (${r.status}). Check Firebase rewrites.`
                                            });
                                        }
                                        displayResults();
                                    })
                                    .catch(() => {
                                        checks.push({
                                            name: 'Service Worker',
                                            pass: false,
                                            message: `Cannot access service-worker.js file. Error: ${error.message}`
                                        });
                                        displayResults();
                                    });
                            });
                    }
                })
                .catch(error => {
                    checks.push({
                        name: 'Service Worker',
                        pass: false,
                        message: `Error checking registration: ${error.message}`
                    });
                    displayResults();
                });
        } else {
            checks.push({
                name: 'Service Worker',
                pass: false,
                message: 'Service Workers not supported in this browser'
            });
            displayResults();
        }
        
        // Check 4: Icons exist
        Promise.all([
            fetch('/icon-192.png').then(r => r.ok),
            fetch('/icon-512.png').then(r => r.ok)
        ]).then(([icon192, icon512]) => {
            checks.push({
                name: 'Icon Files',
                pass: icon192 && icon512,
                message: icon192 && icon512 
                    ? 'Both icon files are accessible ‚úì' 
                    : `Icons missing: 192=${icon192}, 512=${icon512}`
            });
            displayResults();
        }).catch(() => {
            checks.push({
                name: 'Icon Files',
                pass: false,
                message: 'Cannot verify icon files'
            });
            displayResults();
        });
        
        function displayResults() {
            if (checks.length < 5) return; // Wait for all checks
            
            results.innerHTML = checks.map(check => `
                <div class="check ${check.pass ? 'pass' : 'fail'}">
                    <strong>${check.name}:</strong> ${check.message}
                </div>
            `).join('');
            
            const allPass = checks.every(c => c.pass);
            if (allPass) {
                results.innerHTML += '<div class="check info"><strong>‚úÖ All checks passed! Your PWA should be installable.</strong><br>If you don\'t see the install prompt, try:<br>1. Clear browser cache and reload<br>2. Visit the site multiple times (browsers need engagement)<br>3. Check browser-specific install instructions</div>';
            }
        }
        
        // Install button
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'block';
            document.getElementById('installStatus').textContent = 'Install prompt is available!';
        });
        
        document.getElementById('installBtn').addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        document.getElementById('installStatus').textContent = 'App installed!';
                    } else {
                        document.getElementById('installStatus').textContent = 'Installation declined';
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn').style.display = 'none';
                });
            }
        });
    </script>
</body>
</html>

